function stm = cr3bp_dstm(r,mu)
%CR3BP_DSTM Returns the Jacobian Matrix [A] (dSTM/dY) stm(i+1)=A*stm 
% Proceedurally generated by MATLAB Symbolics

x = r(1);
y = r(2);
z = r(3);


t2 = mu+x;
t3 = mu.*2.0;
t4 = x.*2.0;
t5 = y.^2;
t6 = z.^2;
t7 = mu-1.0;
t8 = t2-1.0;
t9 = t2.^2;
t10 = t2.*2.0;
t11 = t8.^2;
t12 = t8.*2.0;
t13 = t5+t6+t9;
t14 = t5+t6+t11;
t15 = 1.0./t13.^(3.0./2.0);
t16 = 1.0./t13.^(5.0./2.0);
t17 = 1.0./t14.^(3.0./2.0);
t18 = 1.0./t14.^(5.0./2.0);
t20 = t7.*t15;
t23 = t7.*t16.*y.*z.*3.0;
t19 = mu.*t17;
t22 = mu.*t18.*y.*z.*3.0;
t24 = -t23;
t21 = -t19;
t25 = t22+t24;
%stm = reshape([0.0,0.0,0.0,t20+t21+mu.*t11.*t18.*3.0-t7.*t9.*t16.*3.0+1.0,mu.*t8.*t18.*y.*3.0-t2.*t7.*t16.*y.*3.0,mu.*t8.*t18.*z.*3.0-t2.*t7.*t16.*z.*3.0,0.0,0.0,0.0,mu.*t8.*t18.*y.*3.0-t2.*t7.*t16.*y.*3.0,t20+t21+mu.*t5.*t18.*3.0-t5.*t7.*t16.*3.0+1.0,t25,0.0,0.0,0.0,mu.*t8.*t18.*z.*3.0-t2.*t7.*t16.*z.*3.0,t25,t20+t21+mu.*t6.*t18.*3.0-t6.*t7.*t16.*3.0,1.0,0.0,0.0,0.0,-2.0,0.0,0.0,1.0,0.0,2.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0],[6,6]);
stm = reshape( ...
    [0.0,0.0,0.0, ...
    t20+t21+mu.*t11.*t18.*3.0-t7.*t9.*t16.*3.0+1.0, ...
    mu.*t8.*t18.*y.*3.0-t2.*t7.*t16.*y.*3.0, ...
    mu.*t8.*t18.*z.*3.0-t2.*t7.*t16.*z.*3.0, ...
    0.0,0.0,0.0, ...
    mu.*t8.*t18.*y.*3.0-t2.*t7.*t16.*y.*3.0,t20+t21+mu.*t5.*t18.*3.0-t5.*t7.*t16.*3.0+1.0, ...
    t25,0.0,0.0,0.0, ...
    mu.*t8.*t18.*z.*3.0-t2.*t7.*t16.*z.*3.0,t25,t20+t21+mu.*t6.*t18.*3.0-t6.*t7.*t16.*3.0,1.0,0.0, ...
    0.0,0.0,-2.0,0.0,0.0,1.0,0.0,2.0,0.0,0.0,0.0,0.0,1.0,0.0,0.0,0.0],[6,6]);





% Script Used to Generate This Function
%{
% Create 3BP STM Function
% 07APR22

clear; clc; close all; format long g;

syms x y z dx dy dz mu
Y = [x y z dx dy dz].';
r1 = (((x+mu)^2)     + (y^2) + (z^2))^(3/2);
r2 = (((x-(1-mu))^2) + (y^2) + (z^2))^(3/2);

d2x = x + 2*dy -(1-mu)*((x+mu)/r1) - mu*((x-(1-mu))/r2);
d2y = y - 2*dx -(1-mu)*((y)/r1) - mu*(y/r2);
d2z = -(1-mu)*((z)/r1) - mu*(z/r2);
dYdt = [dx; dy; dz; d2x; d2y; d2z];

A = jacobian(dYdt, Y);
%A = subs(A,'(x^2+y^2)^(5/2)','r^5'); A = subs(A,'(x^2+y^2)^(3/2)','r^3');
%A = subs(A,'(x^2+y^2)^(1/2)','r'); A = subs(A,'(x^2+y^2)','r^2');

%}


end